// Prisma schema for Parts Management System

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Vendor model - manages supplier/vendor information
model Vendor {
  id           Int      @id @default(autoincrement())
  name         String
  code         String   @unique
  contactName  String?
  email        String?
  phone        String?
  address      String?
  city         String?
  state        String?
  zipCode      String?
  country      String   @default("USA")
  website      String?
  notes        String?
  isActive     Boolean  @default(true)
  rating       Int?     @default(0) // 0-5 rating
  leadTimeDays Int      @default(7) // Average lead time in days
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  parts        Part[]
  orders       Order[]
}

// Category model - for organizing parts
model Category {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  parentId    Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Self-relation for subcategories
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")

  // Relations
  parts       Part[]
}

// Part model - core product/part information
model Part {
  id              Int      @id @default(autoincrement())
  partNumber      String   @unique
  name            String
  description     String?
  categoryId      Int?
  vendorId        Int?
  unitPrice       Float    @default(0)
  unitOfMeasure   String   @default("EA") // EA, BOX, CASE, etc.
  weight          Float?
  dimensions      String?  // LxWxH format
  manufacturer    String?
  manufacturerPN  String?  // Manufacturer part number
  barcode         String?
  imageUrl        String?
  specifications  String?  // JSON string for flexible specs
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  category        Category?        @relation(fields: [categoryId], references: [id])
  vendor          Vendor?          @relation(fields: [vendorId], references: [id])
  inventory       Inventory?
  orderItems      OrderItem[]
  inventoryLogs   InventoryLog[]
}

// Inventory model - tracks stock levels and reorder settings
model Inventory {
  id              Int      @id @default(autoincrement())
  partId          Int      @unique
  quantityOnHand  Int      @default(0)
  quantityReserved Int     @default(0) // Reserved for pending orders
  reorderPoint    Int      @default(10) // Trigger reorder when qty falls below
  reorderQuantity Int      @default(50) // How much to order
  maxQuantity     Int?     // Maximum stock level
  location        String?  // Warehouse/bin location
  lastCountDate   DateTime?
  lastOrderDate   DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  part            Part     @relation(fields: [partId], references: [id], onDelete: Cascade)
}

// InventoryLog model - tracks all inventory movements
model InventoryLog {
  id            Int      @id @default(autoincrement())
  partId        Int
  changeType    String   // RECEIVE, SHIP, ADJUST, RESERVE, UNRESERVE, RETURN
  quantityChange Int     // Positive for additions, negative for subtractions
  previousQty   Int
  newQty        Int
  orderId       Int?     // Reference to related order if applicable
  reason        String?
  performedBy   String?
  createdAt     DateTime @default(now())

  // Relations
  part          Part     @relation(fields: [partId], references: [id], onDelete: Cascade)
  order         Order?   @relation(fields: [orderId], references: [id])
}

// Order model - purchase orders to vendors
model Order {
  id              Int         @id @default(autoincrement())
  orderNumber     String      @unique
  vendorId        Int
  status          String      @default("DRAFT") // DRAFT, PENDING, APPROVED, ORDERED, SHIPPED, RECEIVED, CANCELLED
  orderDate       DateTime?
  expectedDate    DateTime?
  receivedDate    DateTime?
  subtotal        Float       @default(0)
  tax             Float       @default(0)
  shipping        Float       @default(0)
  total           Float       @default(0)
  notes           String?
  shippingAddress String?
  trackingNumber  String?
  isAutoGenerated Boolean     @default(false) // True if created by auto-reorder
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  vendor          Vendor        @relation(fields: [vendorId], references: [id])
  items           OrderItem[]
  inventoryLogs   InventoryLog[]
}

// OrderItem model - line items in an order
model OrderItem {
  id            Int      @id @default(autoincrement())
  orderId       Int
  partId        Int
  quantity      Int
  unitPrice     Float
  totalPrice    Float
  quantityReceived Int   @default(0)
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  order         Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  part          Part     @relation(fields: [partId], references: [id])
}

// ReorderAlert model - tracks auto-reorder notifications
model ReorderAlert {
  id            Int      @id @default(autoincrement())
  partId        Int
  partNumber    String
  partName      String
  currentQty    Int
  reorderPoint  Int
  reorderQty    Int
  vendorId      Int?
  vendorName    String?
  status        String   @default("PENDING") // PENDING, ORDERED, DISMISSED
  orderId       Int?     // Link to created order
  createdAt     DateTime @default(now())
  processedAt   DateTime?
}
